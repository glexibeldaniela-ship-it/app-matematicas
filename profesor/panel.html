<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Panel del Profesor</title>
</head>
<body>

  <h1>Panel del Profesor ğŸ‘¨â€ğŸ«</h1>

  <h2>Publicar GuÃ­a (Google Drive)</h2>

  <input type="text" id="titulo" placeholder="TÃ­tulo de la guÃ­a"><br><br>

  <textarea id="descripcion" placeholder="DescripciÃ³n de la guÃ­a"></textarea><br><br>

  <input type="text" id="driveURL" placeholder="Pega aquÃ­ el link de Google Drive"><br><br>

  <button id="publicar">Publicar GuÃ­a</button>

  <hr>

  <h2>GuÃ­as Publicadas</h2>
  <div id="listaGuias"></div>

<script type="module">

console.log("ğŸ”¥ SCRIPT PANEL CARGADO");

import { auth } from "../firebase.js";
import { db } from "../firebase.js";

import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { collection, addDoc, getDocs, query, orderBy } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const lista = document.getElementById("listaGuias");
const boton = document.getElementById("publicar");

/* ğŸ” ProtecciÃ³n del Panel */
onAuthStateChanged(auth, (user) => {

  if (!user) {
    alert("No has iniciado sesiÃ³n");
    window.location.href = "../index.html";
  } else {
    console.log("Usuario activo:", user.email);
  }

});


/* ğŸš€ Publicar guÃ­a */
boton.addEventListener("click", async () => {

  console.log("BotÃ³n presionado");

  const user = auth.currentUser;

  if (!user) {
    alert("Debes iniciar sesiÃ³n");
    return;
  }

  const titulo = document.getElementById("titulo").value.trim();
  const descripcion = document.getElementById("descripcion").value.trim();
  const driveURL = document.getElementById("driveURL").value.trim();

  if (!titulo || !descripcion || !driveURL) {
    alert("Completa todos los campos");
    return;
  }

  try {

    await addDoc(collection(db, "guias"), {
      titulo,
      descripcion,
      driveURL,
      profesor: user.email,
      fecha: Date.now()
    });

    alert("GuÃ­a publicada correctamente âœ…");

    document.getElementById("titulo").value = "";
    document.getElementById("descripcion").value = "";
    document.getElementById("driveURL").value = "";

    cargarGuias();

  } catch (error) {
    console.error("ğŸ”¥ ERROR REAL:", error);
    alert("Error: " + error.message);
  }

});


/* ğŸ“š Cargar guÃ­as */
async function cargarGuias() {

  lista.innerHTML = "";

  try {

    const q = query(collection(db, "guias"), orderBy("fecha", "desc"));
    const snapshot = await getDocs(q);

    snapshot.forEach((doc) => {

      const guia = doc.data();

      lista.innerHTML += `
        <div style="border:1px solid gray; padding:10px; margin:10px;">
          <h3>${guia.titulo}</h3>
          <p>${guia.descripcion}</p>
          <a href="${guia.driveURL}" target="_blank">
            ğŸ“¥ Ver en Drive
          </a>
        </div>
      `;

    });

  } catch (error) {
    console.error("Error cargando guÃ­as:", error);
  }

}

cargarGuias();

</script>

</body>
</html>